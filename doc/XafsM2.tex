\documentclass[titlepage,a4paper,12pt]{jarticle}
\usepackage{my}
\usepackage{hangcaption}
\usepackage{wrapfloat}
\usepackage[dvipdfm]{graphics}
\usepackage{txfonts}

\setlength{\topmargin}{0cm}
\setlength{\oddsidemargin}{-0.79cm}
\setlength{\evensidemargin}{-0.79cm}
\setlength{\textheight}{23cm}
\setlength{\textwidth}{17.5cm}
\newcommand{\TWpt}{1.0}        % jarticle
\pagestyle{headings}

\renewcommand{\topfraction}{0.99}
\renewcommand{\bottomfraction}{0.99}
\renewcommand{\textfraction}{0.00}
\renewcommand{\floatpagefraction}{.99}
\renewcommand{\dbltopfraction}{0.99}
\renewcommand{\dblfloatpagefraction}{.99}

\renewcommand{\textfloatsep}{0.3cm}
\renewcommand{\dbltextfloatsep}{0.3cm}

\newcommand{\CAP}[1]{\caption{\small #1}}

\title{
  {\gt\fontsize{120pt}{0pt}\selectfont
    XafsM2 \\}
  \vspace*{1cm}
  {\LARGE
    Introduction to \\
    XAFS measurement program Ver. 2\\
    Manual version 0.0
  }
  \vspace*{0.8cm}
}
\author{名古屋大学シンクロトロン光研究センター\\田渕雅夫}
\date{                            2013/1/14 }

\begin{document}

\pagenumbering{roman}
\maketitle
\tableofcontents

%----------------------------------------------------------------------------
\newpage
\pagenumbering{arabic}
\setcounter{page}{1}
%----------------------------------------------------------------------------

\section{はじめに}

あいちシンクロトロン光センタの硬X線XAFS測定ライン BL5S1 で、
ユーザーがビームラインやハッチ内の機器を操作し、測定条件を整えたり、
実際のXAFS測定を行ったりする際の統合的なマン・マシンインターフェイスとして
XafsM2 を準備しました。

このマニュアルでは XafsM2 の機能と操作法を説明しますが、
あとがきでも触れた様に、XafsM2 そのものが、まだ最終版というわけではないため
マニュアルとのズレが出てくる可能性もあります。
それでもビームラインの運用開始にあたってマニュアルの役目をする文章が無くては
困るという事から、プログラムの変更にあたっては
極力文章のアップデートを図ることとし、暫定版を作成することにしました。

本マニュアルと実際のプログラムが違う場合には上記の様な理由です。
違いが大きすぎて分かりにくい、問題があるという場合や、
本マニュアルに無い新規の機能があって使い方がわからない、という場合には
作者にご連絡下さい。
できるだけ早急に対応したいと思います。


\FIG{b}{
  \hfil\scalebox{\TWpt}{\scalebox{0.45}{\includegraphics{OutLookAll.eps}}}
  \CAP{XafsM2の全景}\label{XafsM2の全景}
}

\newpage
\section{XafsM2 の概要}

図\ref{XafsM2の概観}に XafsM2 起動時の概観を示します。

XafsM2 では、「XAFS 測定を行う」という事以外に、
測定に関わる事柄をできるだけ統一的に行えるようにすることを目標にしています。
そのため、「測定条件を決める」、「検出器の調整を行う」、
「プログラムや制御対象の状態を把握する」
など多くの機能を持たせました。
この様な多くの機能をできるだけ簡便に利用できるようにするため、
それぞれの機能を目的ごとにグループ分にけ、
ブロック化して提示するようになっています。

図\ref{XafsM2の概観}に示す様に、XafsM2 の GUI の画面は、
概観するとメニューバーの下に3段のブロックをなす構造になっています。
1段目、画面上部にまとめられているのは、
XAFS の測定で最も重要になる、測定対象元素・吸収端の選択と
現在の入射X線エネルギー表示で、常に表示されます。
(近くここにリングカレントの表示が追加される予定)

\FIG{b}{
  \hfil\scalebox{\TWpt}{\scalebox{0.35}{\includegraphics{OutLook1.eps}}}
  \CAP{XafsM2の概観}\label{XafsM2の概観}
}

2段目は、色々な操作がグループ分けされ、機能ごとにまとまったタブになっていて、
その時々に必要なタブを選択することになります。

最下段は、データやグラフの表示エリアで、ここもタブになっていて
複数面(現状最大10面)のデータやグラフを切り替えて表示することができます。

\section{共通表示部}

XafsM2 の GUI の最上段は、元素選択を行うことと、分光器の状態を表示する部分で
他の部分でタブ選択を行なって表示を切り替えても常に表示されています。

\subsection{元素選択}

図\ref{元素選択部}に示すのが測定対象元素の選択部分です。
実際に元素を選択する方法は2つあります。
一つは図\ref{元素選択部}で「29 Cu」と表示されている元素選択ボックスをクリックし、
現れる図\ref{元素選択ボックス}の様な一覧の中から選択する方法です。
もうひとつは同じく図\ref{元素選択部}で「周期表」と表示されているボタンをクリックし、
現れる周期表(図\ref{周期表})の中から元素を選択する方法です。

元素を選択すると、「エッジ位置」の表示の右に選択した元素の吸収端のエネルギーと
そのエネルギーに対応する分光器の角度が表示されます。
また「対象殻」のボックスで吸収端の種類(K, L$_{\rm I}$, L$_{\rm II}$, L$_{\rm III}$)を
選択すると、対応するエッジのエネルギーと角度の表示になります。

この部分で元素を選択し、
表示された値は実際には XafsM2 の中では参考情報のような扱いで、
\NITEM{
  \item 対象元素のエッジがどこにあるかを人間に教える
  \item 後で述べる「XAFS測定」のタブの中で標準の測定条件の自動生成の際の基準に使われる
  \item 同じく後に述べる「条件設定」のタブの中で、標準的な分光器移動位置を決める
}
という3つの目的にだけ使われます。

「エッジ位置」のエネルギーまたは角度は対象元素を指定して自動表示させるだけでなく
手動で任意の値を入力することができます。
手動で値を入力すると、
「XAFS測定」のタブの中での標準の測定条件の自動生成は指定したエネルギー(または角度)を
基準にして行なわれます。

\FIG{t}{
  \MINI{8cm}{
    \hfil\scalebox{\TWpt}{\scalebox{0.70}{\includegraphics{ElementSelect.eps}}}
    \CAP{測定対象の元素選択部分}\label{元素選択部}
  }
  \MINI{8cm}{
    \hfil\scalebox{\TWpt}{\scalebox{0.80}{\includegraphics{ElementSelectBox.eps}}}
    \CAP{測定元素選択ボックスと元素一覧表}\label{元素選択ボックス}
  }
}

\FIG{t}{
  \FC{\MINI{12cm}{
    \hfil\scalebox{\TWpt}{\scalebox{0.60}{\includegraphics{PeriodicTable.eps}}}
    \CAP{周期表を使った元素選択。
      黄色に表示されているのはK端がラインのエネルギー範囲に適した元素。
      桃色に表示されているのはL端がラインのエネルギー範囲に適した元素。
    }\label{周期表}
  }}
}

\subsection{分光器の状態表示}

\FIG{t}{
  \hfil\scalebox{\TWpt}{\scalebox{0.80}{\includegraphics{Monochro.eps}}}
  \CAP{分光器の角度と分光エネルギーの表示}\label{分光器状態表示}
}

図\ref{分光器状態表示}に示すのは、分光器
\footnote{
BL5S1 の分光結晶は対称 Si (111) で、プログラム内では
その面間隔は 3.13553 \AA としています。
メニューバーの「設定」から「結晶・格子定数設定」を選ぶことで、
分光結晶を選択するダイアログが現れますが、これは XafsM2 を他のnビームラインで
使用する時の為のもので、BL5S1 ではこれが必要になることはおそらく無いと思われます。
}
の角度と分光される光のエネルギーを
示す部分です。

図の中にあるチェックボタンで「エンコーダ」を選択すると、表示される角度は
分光器の角度をエンコーダで読み取った結果になり、
エネルギーもその角度から計算されたエネルギーになります。
一方、チェックボックスで「パルス換算」を選択すると、
分光器を回転させているパルスモータのパルス値から$1パルス = 0.00002\dot{7}$degという関係で
計算した角度とエネルギーです。

このチェックボタンは通常「エンコーダ」を選択することをお勧めします。
分光器を回転しているとパルスモータのパルス値と角度の関係を決める際の原点位置は
ズレが生じる可能性があります。
その場合、パルスモータの原点を再定義して正しい表示に戻すのは多少面倒です。
そのような場合でもエンコーダは(正しく較正されていれば)正しい角度を示すはずです。
また、エンコーダの較正が正しいかどうかは、標準的なフォイルのスペクトルを
測定することなどで確認でき、ズレがあった場合でも簡単な操作で修正できます。
具体的な方法は\ref{エネルギー較正}節を参照して下さい。

{\bf 【注意】 測定結果のファイルに記録される「角度」もしくは「エネルギー」と
して書き込まれる値も、このチェックボタンの選択で決まります。}



\section{機能選択部}

XafsM2 の GUI の中段部分は、XafsM2の機能が幾つかのグループに分類されて
まとまったタブになっています。
現在このタブ(機能のグループ)としては、「XAFS測定」、「条件設定」、「SSD設定」、
「データ読込」、「ログ/記録」、「接続状態」があります\REM{(図\ref{タブ一覧})}。

以下、各タブにまとめられた機能について説明します。

\REM{
\FIG{h}{
  \hfil\scalebox{\TWpt}{\scalebox{0.80}{\includegraphics{Tabs.eps}}}
  \CAP{機能選択のためのタブ一覧}\label{タブ一覧}
}}

\FIG{b}{
  \hfil\scalebox{\TWpt}{\scalebox{0.80}{\includegraphics{MeasTab.eps}}}
  \CAP{XAFS測定タブの全体}\label{XAFS測定タブ}
}

\subsection{XAFS測定}

図\ref{XAFS測定タブ}に示す「XAFS測定タブ」には、実際に XAFS 測定を行う際に使用する
機能がまとめられています。

「測定開始」の項にもありますが、
XAFS測定のタブで入力したほとんどの全ての項目は、測定開始後に変更しても
始まってしまった測定には影響を与えません。
「スキャン回数」は例外で測定開始後も変更可能です。

\subsubsection{測定ブロック設定}

タブの左半分を占める「測定ブロック設定」部分では、XAFS測定の際、
どの様なエネルギー範囲を、どの様な刻みで、各点にどれだけの時間をかけて
測定を行うかを設定します。
以下、図\ref{測定ブロック設定}に赤字で記入した番号の要素について説明します。

\FIG{t}{
  \hfil\scalebox{\TWpt}{\scalebox{0.80}{\includegraphics{MeasTab-BlockSetUp.eps}}}
  \CAP{測定時のブロック設定を行う部分}\label{測定ブロック設定}
}

\NENUMERATE{
  \item ブロック数指定: 測定するエネルギー範囲を幾つのブロックに分けるかを指定します。
    現在指定可能な最大ブロック数は 8 です。
  \item 単位指定: ブロックの始点、終点や間隔をどのような単位で入力するかを指定します。\\
    ここで、単位を変更すると、入力済みの数値に関しては自動的に単位換算が行われます。
  \item ブロック始点: ブロックの始点を指定します。
    始点は同時に前のブロックの終点になります。\\
    前後のブロックの「間隔」が入力済みの場合(0でない場合)、
    $(ブロック始点-ブロック終点)/間隔=刻数$となるよう自動的に「刻数」が変更されます。
  \item 間隔: ブロック内で測定の間隔を指定します。\\
    間隔を入力すると$(ブロック始点-ブロック終点)/間隔=刻数$となるよう
    自動的に「刻数」が変更されます。
    間隔は、始点、終点の大小関係によらず「絶対値」で入力して構いません
    (終点のほうが小さい時でも負の数にしなくて良い)。
  \item 刻数: ブロック内に何点の測定点をとるかを指定します。\\
    刻数を入力すると$(ブロック始点-ブロック終点)/刻数=間隔$となるよう
    自動的に「間隔」が変更されます。
  \item 計測時間: 各点をどれだけの時間で測定するかを指定します。単位は「秒」です。
  \item ブロック終点: 最後のブロックの次の始点は、最後のブロックの終点の指定です。
  \item All: 全ブロックの計測時間を一括で指定します。
  \item 標準ボタン: XafsM2 の上部で指定された測定対象元素(厳密には「エッジ位置」)を
    中心に、標準的な測定ブロックの指定を生成します。\\
    「標準EXAFS」は EXAFS 領域まで広がったエネルギー範囲を測定範囲とします。
    「標準XANES」は XANES 領域を測定対象にします。
    「標準XAFS」は EXAFS と同じエネルギー範囲を測定対象にし、
    XANES エリアは XANES 測定と同じ細かな測定ステップを指定します。
  \item 保存・読込: 設定したブロック指定を保存したり、
    保存したブロック指定を読み込んだりすることができます。
}


\FIG{b}{
  \hfil\scalebox{\TWpt}{\scalebox{0.80}{\includegraphics{MeasTab-Right.eps}}}
  \CAP{XAFS測定タブの右半分}\label{XAFS測定タブ右}
}

\subsubsection{検出器設定}

タブの右上部では測定に使う検出器を指定します。

左端の、チェックボタンで選択された検出器が測定に使用される検出器です。
「I0」は常に選択され、非使用にすることはできません。
残りの「I」、「19ch SSD」、「その他 1」、「その他 2」は複数選択可能ですが
最低1つは選択していないと測定が始まりません。

図\ref{XAFS測定タブ右}に示した 1. は、
検出器として「その他1」、「その他2」を選んだ場合の測定のタイプを選択するボックスです。
透過型の測定なら$log(I_0/A_1)$(または、$log(I_0/A_2)$)を、
蛍光型の測定なら$A_1/I_0$(または$A_2/I_0$)を選んで下さい。

現在 XafsM2 では、測定結果を記録するファイルのフォーマットは、
いわゆる「9808」型のファイルです。
このファイルには、全体で一つ測定のタイプを記録するフィールドがありますが、
XafsM2 では、「選択した検出器が一つだけ」の場合、
\NITEM{
  \item I を選択: 透過型の測定と記録
  \item 19ch SSD を選択: 蛍光型の測定と記録
  \item その他1 または 2 を選択: $log(I_0/A)$ を選んでいれば透過型の測定と記録、
    $A/I_0$の場合には蛍光型の測定と記録
}
という規則でファイルに記録します。
複数の検出器を指定した場合には全て EXTRA型の測定と記録します
\footnote{
  複数の検出器を選択してもそのタイプが全て一致していれば(全部透過型とか蛍光型に)、
  測定ファイルには「そのタイプの測定」と記録しても良いのですが、現在そうなっていません。
  ファイル全体に一つの記録モード指定以外にも、
  検出器ごとに測定モードを記録できるフィールドがあるので問題にならないはずです。
}。
ここでの「測定の型」の選択は、測定中の測定結果の表示にも影響します。

検出器選択ボックスにどの様な検出器が現れるかは、
XafsM2 に固定に組み込まれているわけではなく、ビームラインの状況に合わせて
設定ファイルで設定するものです。
従って、この内容を説明することはプログラムのマニュアルの範疇を超えているのですが、
全く説明がないのも不便なので \ref{検出器選択ボックスの表示}節に
2013年1月現在の BL5S1 の設定を例にとった説明をしました。

\subsubsection{バックグラウンド}\label{バックグラウンド}
XAFS測定タブの右中段には、バックグラウンドを扱う部分があります。
XafsM2 では、バックグラウンドをいつ測定するかに関して、
\NITEM{
  \item XAFS測定(スキャン)の直前に測定する
  \item バックグラウンドの値を事前に測定しておく
  \item バックグラウンドの値を手入力する
}
という 3つの選択肢があります。

測定の直前に測定する場合には、図\ref{XAFS測定タブ右}の 2. で
「スキャン前に計測」を選択して下さい。
「計測済みの値を使用」を選択すると、事前に計測するか手入力した値を使用することになります。

「計測済みの値を使用」を選択した場合、XAFS測定開始前にバックグラウンドの値を測定するか、
手入力しておく必要があります。バックグラウンドを計測するには次の様にして下さい。
\NENUMERATE{
  \item 図\ref{XAFS測定タブ右}の 3. に、計測時間を入力する。
  \item 図\ref{XAFS測定タブ右}の 4. の「バックグラウンド計測」ボタンを押す。
  \item ボタンの色が図\ref{バックグラウンド計測ボタン}の様に赤く変化し、
    表示も「シャッターCLOS確認」に変わる。
  \item シャッターが閉まっていることを確認して、このボタンを押す。
  \item ボタンの色が今度は黄色に変化し、表示は「BG計測中」に変わる。
  \item 計測後、ボタンの色が再び赤くなり、表示が「シャッターOPEN確認」に変わる。
  \item 必要ならばシャッターを開け(不要ならば開けなくても構わない)
    もう一度このボタンを押す。
  \item ボタンの表示が元に戻り、計測プロセス終了。
}
バックグラウンドの値は、内部的には「1秒あたり」の数字として記憶されますので
測定の際の各点の計測時間とバックグラウンドの計測時間が一致する必要はありません。

バックグラウンドの値を手入力する場合は後で説明する「条件設定」タブの中で行います。

「スキャン前に計測」を選択した場合、計測(スキャン)開始のボタンを押した後、
「バックグラウンド計測」ボタンの色と表示が上記の説明と同様に変化しますので
指示に従ってシャッターの開閉を行なって下さい
\footnote{近い将来シャッターの開閉を自動でお行なうようにする予定ですので、
「表示に従ったボタン操作」は不要に和るかもしれません。}。

\FIG{b}{
  \hfil\scalebox{\TWpt}{\scalebox{0.80}{\includegraphics{BGMeasB.eps}}}
  \CAP{「バックグラウンド計測」ボタンの変化}\label{バックグラウンド計測ボタン}
}

\subsubsection{データファイル}

XAFS測定タブの右三段目の「データファイル」の項では、
測定結果を記録するデータファイル名の選択と、
データファイルにコメントとして書き込む文字列の入力を行います。

複数回スキャンを行う場合、
データファイル名の拡張子(通常は「.dat」)は、自動的に変更され
1回目もとの拡張子、2回目「.001」、3回目「.002」、... の様に設定されます。

この、拡張子が変更されたファイル名に関してはすでに存在しているファイルかどうか、
上書きのチェックは行なっていません。

\subsubsection{条件確認}

XAFS測定タブの右最下段の「条件確認」の項には、
総測定点数と予想測定時間が表示されます。
この項目はどちらも表示だけです。
予想測定時間は測定点数に確定点の測定時間をかけて加え上げただけのもので
実際の測定時間はこの1.5倍程度になることがあります。

\subsubsection{測定開始}

XAFS測定タブの右最下段の「測定開始」の項では、
測定終了時に分光器の角度をどこに移動するかと、スキャンを何回繰り返すかを指定できます。

XAFS測定のタブで入力した他の項目は、測定を開始した後に変更しても、
始まってしまった測定には影響を与えませんが、{\bf 「スキャン回数」だけは
測定開始後も変更可能です。}

\subsubsection{測定結果の表示}

測定結果はグラフとして XafsM2 の最下段の View タブに表示されます。
XAFS測定中に表示されるグラフと、そのグラフに対して可能な操作に関しては
\ref{XYView}節を参照して下さい。

\subsection{条件設定}

図\ref{条件設定タブ}に示す「条件設定タブ」には、
XAFS測定を開始する前に、試料や測定系の状態を確認したり、測定条件を
決めるための機能がまとまっています。

\FIG{t}{
  \hfil\scalebox{\TWpt}{\scalebox{0.80}{\includegraphics{MeasCond.eps}}}
  \CAP{条件設定タブの全体}\label{条件設定タブ}
}

\subsubsection{分光器回転}

条件設定タブの左上部「分光器回転」では
分光器を希望のエネルギー、角度に移動させることができます(図\ref{分光器回転})。

図\ref{分光器回転}の 1. に示すように移動先は 4つまで入力できるので
決まった何点かを交互に移動しながら
測定条件を決めるようなことに利用できます。
「元素選択」で元素と吸収端を選ぶと、それに合わせてデフォルトの移動先が設定されます。
デフォルトは吸収端のエネルギーを基準にして
 -0.5keV, -0.1keV, +0.1keV, +1.0keV の 4点です。

移動先を設定する際の単位は、それぞれの入力欄の右の選択ボックス(図\ref{分光器回転}の 2.)
で変えられます。
選択できる単位は keV, eV, deg, \AA の 4種類です。
単位を変えると、入力されている数字は自動的に選択した単位に変換されるので、
あるエネルギーに対応する角度を調べる、というような用途にも使えます。

図\ref{分光器回転}の 3. のエネルギー選択ボックスで単位を変えると、
4つの単位入力を一斉に変更することができます。

図\ref{分光器回転}の 4.の「H, M, L」のボタンを押すことで、
移動する際のパルスモータの速度を選ぶことができます。
どの速度を選んでも構いませんが、「L」で大きな角度移動をすると時間がかかり、
「H」では、到達する角度が指定した角度と多少ずれる可能性がある、
ということを考慮して適宜選択して下さい。

\FIG{t}{
  \hfil\scalebox{\TWpt}{\scalebox{0.80}{\includegraphics{MeasCond-MonoCTRL.eps}}}
  \CAP{分光器を希望のエネルギー、角度に移動させる}\label{分光器回転}
}

\subsubsection{レンジ選択}

\FIG{b}{
  \hfil\scalebox{\TWpt}{\scalebox{0.80}{\includegraphics{MeasCond-Range.eps}}}
  \CAP{測定器のレンジ選択}\label{レンジ選択}
}

XafsM2 で、どの様な計測器を接続して測定ができるようにするかは、
後述する定義ファイル等に依存しますが、
その中に、レンジ選択が必要な検出器・検出系がある可能性があります。
１つの例として、このマニュアルを書いている 2013年1月の段階の BL5S1 では、
「電流/電圧アンプとして Keithley 6485 を使い、
その出力を V/Fコンバーターに通してカウンタ(nct08)につなぐ」という検出系があります
(\ref{検出器選択ボックスの表示}節参照)。
この場合には Keithley をオートレンジで使用してレンジが変わってしまうと
見かけのカウント数が 10倍/0.1倍変化してしまうことになるので、
レンジを固定し、適切なレンジを指定して測定を行う必要があります。

条件設定タブ左の2段目「レンジ選択」(図\ref{レンジ選択})では、このレンジ設定を行います。

図の番号に従って機能を説明すると、以下のようになります。
\NENUMERATE{
  \item 検出器選択: レンジ選択が可能な検出器・系だけが一覧表示されます。
    レンジ設定を行う検出器を選択します。
  \item レンジ設定: 選択した検出器のレンジを設定します。
  \item レンジ取得: 現在検出器に実際に設定されているレンジを読み取り、
    2. の欄に表示します。
  \item 全レンジ取得: 選択していない検出器も含めて、
    全てのレンジ選択可能な検出器に実際に設定されているレンジを読み取ります。
  \item オートレンジ指定: オートレンジが使用可能な検出器の場合、
    このチェックボタンが有効になります。
    ここにチェックを入れると、オートレンジが有効になり、
    2. のレンジ設定が無効になります。
}

レンジの設定を行う際、具体的にどのレンジにすれば良いかを判断するには、
例えば次のような方法があります。

\NITEM{
  \item 完全に手動で判断する場合
    \NENUMERATE{
      \item 対象の検出器を手動でオートレンジにする。
      \item 自分が行おうとする測定の中で最大強度の信号が来ると思われる条件を作る。
      \item その条件下で対象の検出器を動作させる。
      \item 固定レンジで使用している場合には、検出器が飽和しない最小レンジを探す。
      \item オートレンジで使用している場合には、検出器が選択したレンジを読み取る。
    }
  \item 検出器等を XafsM2 経由で操作しながら判断する場合(オートレンジ利用可能な場合)
    \NENUMERATE{
      \item この「レンジ選択」部で「Auto Range」を選び
        対象の検出器をオートレンジにする。
      \item XAFS 測定タブに移動し、オートレンジを選択した検出器を使って
        XAFS 測定を行う。\\
        (実際には XAFS 測定ではなく、
        後述する「ピークスキャン」や「モニタ」のモードで、入力信号が最大になる
        条件を探すのでも構いません。)
      \item 吸収端直後など、検出器への入力が最大になる点で測定を止める。
      \item この「レンジ選択」に戻り、Auto Range を外して「レンジ取得」する。
    }
  \item 検出器等を XafsM2 経由で操作しながら判断する場合(オートレンジ利用不能の場合)
    \NENUMERATE{
      \item この「レンジ選択」部で仮にレンジを選ぶ。
      \item XAFS 測定タブに移動し、オートレンジを選択した検出器を使って
        XAFS 測定を行う。
      \item 吸収端直後など、検出器への入力が最大になる点で測定を止める。
      \item 測定が飽和しているようなら「レンジ選択」に戻ってレンジを上げ、
        飽和していなければレンジを下げる。
      \item これを何度か繰り返す。
    }
}

どれも当たり前の方法ではありますが、
この通常の手順を XafsM2 をどう使って行うかの参考にして下さい。

\subsubsection{バックグラウンド確認/設定}

条件設定タブ左の3段目「バックグラウンド確認/設定」(図\ref{バックグラウンド設定})では
各検出器のバックグラウンドとしてどの様な数値が設定されているかを表示し、
必要に応じて手入力で変更を行うことができます。

\FIG{t}{
  \hfil\scalebox{\TWpt}{\scalebox{0.80}{\includegraphics{MeasCond-Offset.eps}}}
  \CAP{バックグラウンドの設定}\label{バックグラウンド設定}
}

\NENUMERATE{
  \item 検出器選択: バックグラウンドを表示・入力する検出器を選択します。
  \item バックグラウンド表示・入力: 選択された検出器のバックグラウンドが表示されます。
    また、入力欄として使用し、設定する値を入力します。
  \item バックグラウンド設定: バックグラウンドを入力した値に設定します。
}

「XAFS測定」タブでXAFS測定を行う際、「計測済みの値を使用」を選択している時には
バックグラウンドの値を事前に決めておく必要があります。
その方法の一つは「XAFS測定」タブで「バックグラウンド計測」ボタンを押すことですが、
もうひとつの方法は、ここで値を手入力することです。

\subsubsection{移動/スキャン}

\FIG{b}{
  \hfil\scalebox{\TWpt}{\scalebox{0.80}{\includegraphics{MeasCond-MoveScan.eps}}}
  \CAP{駆動軸の移動や、移動に伴う検出値の変化を見る}\label{移動/スキャン}
}

条件設定タブ右上段は「移動/スキャン」となっています(図\ref{移動/スキャン})。
ここでは、分光器を含めた様々な駆動軸を移動させることと、
移動させながら検出器の値を表示し、その変化を見たりピークを探したりすることができます。

図中に赤色の数字で示した部分は、駆動軸を移動する動作に関わっていて
次のような機能を持ちます。

\NENUMERATE{
  \item 駆動軸: どの駆動軸を動かすかを選択します。
  \item 現在位置/移動先: 選択した駆動軸の現在位置の表示欄と、移動先の入力欄です。
    上段は puls(パルスモータの場合)単位で見た位置、
    下段は物理的な単位に直した位置です。
  \item 相対/絶対: 「移動先」の指定が現在位置に対する相対的な指定か
    絶対位置の指定可を選択します。
  \item 速度指定: 移動時の速度を指定します。
    分光器の場合同様、遅いと移動に時間がかかりますが、早いと精度が落ちる時があります。
  \item 移動: 上記の条件を設定した上で実際に駆動軸の位置を移動します。
}

図中に青色の数字で示した部分は、軸を移動しながら計測を行う、
いわゆるスキャンの動作に関わっていて次のような機能を持ちます。

\NENUMERATE{
  \item 検出器設定: スキャンに使う検出器を決めます。\\
    上で選択するのがその検出値をグラフの描画等に使う検出器です。
    下で選択するのは、例えば I0 等、測定対象の強度に何らかの影響を与えると考えられる
    別の量を測っている検出器です。
    グラフには両方の計測結果がプロットされます。
  \item 規格化指定: このボタンをチェックすると、先の検出器設定の上段で選んだ検出器の
    計測値を、下段の検出器の計測値で規格化してプロットします。
    ファイルに出力するのも規格化後の値です。
    規格化の分母になる値が0になる場合、規格化せずそのままの数字になります。
  \item スキャン条件: スキャンする条件の指定です。始点、終点、スキャンする点の間の間隔、
    各点で何秒間測定を行うかを指定します。
  \item 単位指定: スキャン条件(始点、終点、間隔)を指定するときの単位を指定します。
  \item 相対/絶対: 始点、終点の指定が現在位置に対する相対移動なのか、
    絶対値なのかを決めます。
  \item スキャンスピード: 一つの点から次の点へ移動速度する際の速度指定です。
  \item スキャン開始: ここまでで決めた条件でスキャンを行います。
  \item 選択・保存: スキャン結果を保存するファイルを指定し、保存を行います。
    「保存」はスキャン後に押して下さい。スキャン前にファイル名が選択されていても
    自動的には保存されません。
}

スキャンの結果はグラフとして XafsM2 最下段の View タブに表示されます。
スキャンで表示されるグラフと、そのグラフに対して可能な操作に関しては
\ref{XYView}節を参照して下さい。

\subsubsection{検出器モニタ}

\FIG{b}{
  \hfil\scalebox{\TWpt}{\scalebox{0.80}{\includegraphics{MeasCond-Monitor.eps}}}
  \CAP{横軸を時間にとって検出器の計測値をモニターする。}\label{モニタ}
}

条件設定タブ右下段は「検出器モニター」(図\ref{モニタ})となっていて
横軸を時間にとって検出器の計測値をモニターすることができます。

検出器モニタでは最大3つの計測器までを同時に計測し、グラフ化することができます。
操作法には特に解説しないといけないようなことはほとんどありませんが、
計測値の記録ファイルの扱いについては少し注意が必要です。

計測値をファイルに記録するかどうかと、記録するファイル名の選択は
{\bf モニタ開始前}に行います。
現時点では、モニタが終わった後、得られたグラフを記録することはできません。

また、モニタを行うファイルとしてすでに存在するファイルを選択した場合、
他のケースでは、既存のファイルの中身を消してしまって新たに記録します。
しかし、モニタで既存のファイルの中身は消されず、
代わりに、すでにあるデータの後ろに追記される形で記録されます。
これは、一時中断しながら、断続的にモニターを行うような場合にその結果を一つの
ファイルに残せるという意味で便利です。
一方で、ファイル名の選択を間違えると、
違うファイルの後ろにデータを追記してしまうことになるので注意が必要です。
(但し、その様な場合でも、
追記するデータの先頭に(前のデータとの隙間に)、
測定開始時間などの情報を含んだヘッダが入りますので、
テキストエディタ等で見れば分離するのは簡単なはずです。)

モニターの様子はグラフとして XafsM2 最下段の View タブに表示されます。
モニターで表示されるグラフと、そのグラフに対して可能な操作に関しては
\ref{TYView}節を参照して下さい。

\subsection{SSD設定}

\FIG{t}{
  \hfil\scalebox{\TWpt}{\scalebox{0.80}{\includegraphics{SSDTab.eps}}}
  \CAP{SSD設定タブの全体}\label{SSD設定タブ}
}

図\ref{SSD設定タブ}に示すのは「SSD設定タブ」です。
左側に、19ch SSDのチャンネルを選択する部分が2箇所あり、
右側では各チャンネルのパラメータの確認と、ROI 設定ができるようになっています。

\FIG{t}{
  \FC{\MINI{8cm}{
    \hfil\scalebox{\TWpt}{\scalebox{0.80}{\includegraphics{SSDTab-Select1.eps}}}
    \CAP{SSD のチャンネル選択 1。ここで選択したチャンネルに対して、
      画面右側でパラメータの確認を行ったり ROI の設定を行えます。}\label{SSD選択1}
  }\hspace*{1cm}
  \MINI{8cm}{
    \hfil\scalebox{\TWpt}{\scalebox{0.80}{\includegraphics{SSDTab-Select2.eps}}}
    \CAP{SSD のチャンネル選択 2。
      検出器として SSD-All を選択した測定では、
      ここで選択したチャンネルのカウントの合計が検出器の出力になります。}\label{SSD選択2}
  }}
}

\subsubsection{SSD選択(MCAスペクトル)}

チャンネル選択は2箇所で行えますが、左上での選択(図\ref{SSD選択1})は排他的で、
一度に1つのチャンネルだけが選べます。
ここで選んだチャンネルは画面右の「SSDの各チャンネルの設定」の対象のチャンネルになります。

\FIG{b}{
  \hfil\scalebox{\TWpt}{\scalebox{0.80}{\includegraphics{SSDTab-Setup.eps}}}
  \CAP{選択したSSDのチャンネルの設定部分}\label{SSD設定部分}
}

\subsubsection{SSD選択(積算/本測定対象)}

一方、左下での選択(図\ref{SSD選択2})では、複数のチャンネルを選択することができます。
これは、SSD を使用した測定を行う際に積算するチャンネルを指定するためのものです。
XAFS測定や、スキャン、モニターを行う際の検出器として「SSD(19ch All)」を選択すると、
画面に描かれるグラフはここで選択したチャンネルだけのデータを積算したものです。
ただし、XAFS測定での測定結果のファイルには、ここでの選択にかかわらず全チャンネルの
データが記録されます。
一方、スキャンやモニタの記録ファイルに記録されるのは、画面に描画されているのと同じ
選択したチャンネルのだけの積算データです。

\subsubsection{SSDの各チャンネルの設定}

図\ref{SSD設定部分}の 1.、「SSDチャンネル」か先に述べた図\ref{SSD選択1}のチャンネル
設定部分でチャンネルを選択すると、選択されたチャンネルに設定されたパラメータが
表示されます。

現時点では、SSDの各チャンネルのパラメータの大半
(ピーキング時間、閾値、校正エネルギー、ダイナミックレンジ、ゲイン)は
設定値を表示するだけで入力はできません。
ここで、できるのは、SSD の各チャンネルに対して MCA スペクトルを取得することと
ROI を設定することです。
以下、図中の番号に対応した説明を行います。

\NENUMERATE{
  \item SSD チャンネル: 対象となる SSD のチャンネルを選択します。
  \item 開始: MCA スペクトルの取得(計測)を開始します。\\
    「開始」を押すと、全チャンネルに対する計測が同時に始まります。
    スペクトルを測定しながら 1. でチャンネルを変更すれば、選択したチャンネルの
    MCA スペクトルが現れます。\\
    「開始」後は表示が「終了」に変わり、これを押すと計測が終了します。
  \item クリア: 計測した(全チャンネルの) MCA スペクトルをゼロクリアします。\\
    計測中(「開始」を押した後)でも、計測停止中でもどちらでも有効です。
  \item Log: このボタンをチェックすると、MCA スペクトル表示の
    縦軸が Log スケールになります。
  \item リアル・ライブ: このボタンをチェックすると
    「リアルタイム」(普通に時計で測った時間)または
    「ライブタイム」(リアルタイムの内でデッドタイムを除き有効に測定ができていた時間)
    を選択して、設定した時間で MCA スペクトルの計測を止めることができます
    (どちらにもチェックを入れなければ計測はいつまでも止まりません)
    \footnote{
      現在、「ライブタイム」設定を使おうとすると、以下のような(小さな)不具合があります。
      設定できる時間は全チャンネルに対して一つですが、
      一般に「ライブタイム」はチャンネルごとに異なり得ます。
      このプログラムで「ライブタイム」設定をしている時、
      MCA スペクトルの計測が止まるのは、
      その時に表示されているチャンネルの「ライブタイム」が設定値を超えた時です。\\
      ほとんど問題にならない不具合だと思いますが、
      チャンネルを頻繁に切り替えて見ているような場合、少し問題になるかもしれません。
    }。
  \item 時間設定: 計測を止める設定時間の入力です。
  \item ROI始点・終点: ROI の始点、終点の設定値の表示と入力を行います。
    始点・終点の設定はグラフの上でマウスカーソルを用いて行うこともできます。
  \item 積分値: ROI 設定範囲内の積分値を表示します。
  \item カーソル点: グラフ表示上でマウスカーソルがある点の計測値を表示します。
  \item 選択・保存: MCA スペクトルを保存するファイルを選択し、保存を行います。
}

\subsubsection{MCAスペクトルの表示}

MCAスペクトルはグラフとして XafsM2 最下段の View タブに表示されます。
MCAスペクトルの表示と、そのスペクトルに対して可能な操作に関しては
\ref{MCAView}節を参照して下さい。

\subsection{データ読み込み}

\FIG{t}{
  \hfil\scalebox{\TWpt}{\scalebox{0.8}{\includegraphics{FileReadTab.eps}}}  % 0.63 ok
  \CAP{データ読込タブでは、XAFS測定、スキャン、モニタ、
    MCAスペクトルのデータを表示可能。}\label{データ読込}
}

\subsubsection{ファイル選択}

図\ref{データ読込}に示すデータ読込タブでは、
XAFS測定、スキャン、モニタ、MCAスペクトルのデータを読み込んで
表示することができます。
どのタイプのデータかは自動的に判定され「タイプ」欄に表示されます。

表示はファイルの「選択」を行った時と、その後の「表示」を押した時のどちらでも行われます。

グラフは、XafsM2 の下段の View 選択タブで、その時に選ばれていた View がまだ未使用で
何もグラフが表示されていない場合、そこに表示されます。
既にグラフが表示されていて、グラフのタイプが「XAFS測定」「スキャン」データの場合には
表示しようとするグラフも同じタイプだと、「データ読込」で選択した選択したデータが
重ねて表示されます。
ただし、横軸が違う場合
(XAFSのデータで、測定エネルギー範囲が違う、SCANのデータで駆動した軸が違う、
駆動範囲が違う等の場合)でも、特に判断せずそのまま表示されます。

グラフのタイプが「モニタ」「MCAスペクトル」の場合、
表示されているデータタイプと表示しようとするデータタイプが異なる場合、
自動的に未使用の View が選択され、そこに表示が行われます。

整理すると、
\NITEM{
  \item 選択中の View が未使用: 読み込んだデータはそこに表示される
  \item 「XAFS測定」「スキャン」のデータが表示中で、
    表示しようとするデータとタイプが一致: 読み込んだデータはそこに重ねて表示される
  \item それ以外: 未使用の View が選択されてそこに表示される
}
となります。

図\ref{データ読込行}に示すように、
データ読込タブのファイル選択を行う一つの行の右端に並んだ小さなボタンの列があります。
ここには、データをグラフ上に表示した時、どの様な色で描画したかを表示すると共に、
このボタンを押すと線の色を変更することができます
(色の変更は「XAFS測定」と「スキャン」のデータにのみ有効)。

\FIG{h}{
  \hfil\scalebox{\TWpt}{\scalebox{0.8}{\includegraphics{FileReadTab-ALine.eps}}}
  \CAP{データ読取タブの一つのライン。右端に並んだ小さなボタンの列は、
    グラフの線の色の表示と選択に使用される。}\label{データ読込行}
}

\subsubsection{データファイルの形式}

\paragraph{\bf データタイプ:}

データタイプの判定は、実際にはグラフの先頭の一行を見て行われています。

XAFS測定データとして、現在 XafsM2 は 9809 フォーマットに準拠しようとしており、
読込もこのタイプのデータに対応しています。
データフィアルは先頭の一行が
「(スペース)(スペース)9809」で始まっている時、XafsM2 はそのファイルが
9809 フォーマットの XAFS測定データだと判定します。

スキャン、モニタ、MCAスペクトルに関してはデータの先頭に
XafsM2 を示す次のような文字列が有った時、それぞれのタイプのデータだと判断します。
\NITEM{
  \item スキャン: 「\# XafsM2 Scan Data」
  \item モニタ: 「\# XafsM2 Monitor Data」
  \item MCAスペクトル: 「\# XafsM2 MCA Data」
}
現在、XafsM2 は上記以外のデータを読み込みません。

\paragraph{\bf データの中身:}

前述したように、「XAFS測定データ」のフォーマットは「9809」フォーマットです。
その他の、タイプのデータでは、先頭に数行「\#」から始まるコメント行があり、
その後にデータ本体が続く形式になっています。

コメント行には、計測開始日時、データを測定した検出器、駆動軸、等の情報が
適宜書き込まれています。
実際に何が書かれているかは、テキストエディタ等でファイルを開いてみると
一目瞭然だと思います。

データ本体は、タブ/スペース区切りのデータ列が行をなして並んでいます。
各行の先頭は横軸に相当する数字、駆動軸や時間、MCAのチャンネルで、
2番目以降の数字がデータです。

\subsubsection{Viewを閉じる}

図\ref{データ読込}に示すデータ読込タブの一番下には、
「Viewを閉じる」ボタンがあります。
このボタンを押すと、その時に選択されて表に表示されている Viewが閉じられます。
但し、XAFS測定中で、データ表示している View など、使用中の View は例外で
閉じようとしても閉じないはずです。

\subsection{ログ/記録}

\FIG{b}{
  \hfil\scalebox{\TWpt}{\scalebox{0.8}{\includegraphics{LogTab.eps}}}
  \CAP{ログ/記録タブには、(現在はまだ整理できていないが将来は)
    XafsM2 対して行った操作やビームラインの状態に関する情報が
    表示され記録される。}\label{記録タブ}
}

図\ref{記録タブ}に示すタブには、
操作やビームラインの状態に関するログが残るようになる予定です。
現状では ここに残すひつようがある情報と不要な情報の整理がついていません。
このため、記録が有用に働くかどうかは不明ですが、
少なくとも分光器の移動の情報だけは記録されます。
近い将来には情報を整理し、軸の移動の記録とシャッターの開閉、
リングのカレント等の情報が残せれば良いと思っています。

ログ/記録タブの上部では、ログファイルを変更できるようになっています。
デフォルトでは、XafsM2 を起動した日付のファイル名が選択され記録されています。

ログ/記録タブの上部には、コメント入力欄があります。
ここで入力したコメントは、ログの一部として記録されます。

\subsection{状態表示}

\FIG{b}{
  \hfil\scalebox{\TWpt}{\scalebox{0.8}{\includegraphics{StatTab.eps}}}
  \CAP{「状態表示」タブ。通常は気にするひつようがない部分です。
    何かトラブルがあった時、原因究明の一助になると期待しています。}\label{状態表示}
}

XafsM2 は、周辺の装置・機器類と接続する上で、基本的には Stars を経由して通信しています。
図\ref{状態表示}に示すタブには、XafsM2 の定義ファイルで接続を支持されたデバイスとの
接続状況や、通信に関する内部変数の状況が表示されています。

XafsM2 は Stars との接続や、Stars を経由した他の機器との接続をダイナミックに扱っていて
(最初に定義ファイルに書かれていないものには繋がりませんが)、
Stars サーバとの通信ができた/できない、
自身が使おうとするデバイスが Stars サーバにつながって ready 状態になっている/いない、
ということを把握しています。
「状態表示」タブにはその内容が表示されています。

従って、状態表示タブの使い方は大きく分けて2つあります。
ひとつは、正常に動いていないデバイスを把握することです。
状態表示タブでずっと赤のままで変化しない表示が出ていたら、
どれかのデバイスが正常に動いていないことを意味します。

もうひとつの使い方は、デバイス異常の状態から逃げることです。
XafsM2 では、かなり気を使ってデバイスの状態監視を行なっているので
正常動作していないデバイスを使用しようとしてロックされてしまう、
という事はめったに起こらないと期待しています。
しかし、かなり稀にですがその様なことが起こることがあります。
例えば、ある検出器がダウンしているのに、
そのステータスが Stars 経由でうまく伝わらなかった場合、
不調の検出器を指定して XAFS測定をスタートしてしまうと、
検出器からの返答がないので、測定が進まなくなることがありえます。
その場合でも、赤表示の横の、「クリア」ボタンを表示が緑になるまで何回か叩くと
問題のあるデバイスを使おうとしたことによるロック状態からは逃げることができます。
そうすれば、不調デバイスの調子を直すことはできませんが、少なくとも
不調デバイスを使わない測定は、改めて進めることができます。


\subsubsection{スターズサーバ状態表示}
\subsubsection{ドライバ状態表示}

\section{グラフ表示部}

\subsection{XYView}\label{XYView}

\subsection{TYView}\label{TYView}

\subsection{MCAView}\label{MCAView}

\section{その他の機能}

\subsection{Starsサーバ選択}

\subsection{メッセージ表示エリア}

\section{標準的な測定操作}

\subsection{標準的なXAFS測定}

\subsection{標準的なエネルギー較正}\label{エネルギー較正}

\subsection{スキャン}

\subsection{分光器の$\Delta\theta_1$の較正}

\section{起動方法・設定}

\section{定義ファイル}

\section{XafsM2 で使用可能なデバイス}

\subsubsection{検出器選択設定に現れる検出器の種類}\label{検出器選択ボックスの表示}

検出器選択ボックスにどの様な検出器が現れるかは、
XafsM2 に固定に組み込まれているわけではなく、ビームラインの状況に合わせて
設定ファイルで設定するものです。
従って、この内容を説明することはプログラムのマニュアルの範疇を超えているのですが、
全く説明がないのも不便なので、2013年1月現在の BL5S1 の設定を例にとって説明します。

BL5S1 で使用可能な検出器は複数ありますが、最も基本となるのはイオンチャンバです。
BL5S1 には 3 台のイオンチャンバがあり、
そのうち2台は $I_0$, $I$測定のために常時使用可能になっていますが、
XafsM2 との接続にはつの異なる経路が可能です。
\NENUMERATE{
  \item イオンチャンバ
    $\Rightarrow$ 応研プリアンプ・V/Fコンバータ
    $\Rightarrow$ nct08 カウンタ $\Rightarrow$ XafsM2
  \item イオンチャンバ
    $\Rightarrow$ Keithley 4685(A/Dコンバータとして使用)
    $\Rightarrow$ XafsM2
  \item イオンチャンバ
    $\Rightarrow$ Keithley 4685(電流アンプとして使用)
    $\Rightarrow$ V/Fコンバータ
    $\Rightarrow$ nct08 カウンタ $\Rightarrow$ XafsM2
}

XafsM2 では、1.の接続をした $I_0$, $I$ チャンバは選択ボックスに、
「Counter 0 (I0)」、「Counter 1 (I)」という名前で現れます。
$I_0$, $I$ に繋がった応研V/Fコンバータの出力を nct08 の 0, 1 チャンネルに
つないでいるからです。

2. の接続は 「Keithley 6485-1」、「Keithley 6485-2」という名前で現れます。
I0, I の記述がないのは、Keithley には他にも色々なものを接続可能で
I0, I 以外がつながっている時も多いからです。

3. の接続は、「Counter 2 (I0 via KTL)」、「Counter 3 (I via KTL)」という名前で
現れます。I0, I を Keithley 経由で接続していて、V/F コンバータの出力を nct08 の
2, 3 チャンネルに繋いでいるからです。

この 3種類の接続は、他にも応用可能で、
まず第一に、検出器として I0, I チャンバ以外のものをつなぐ(例えば Lytle検出器)
ことは常に可能です。
その場合は、ユーザーがそれを承知した上で、
上述の「Counter 1 (I)」、「Keithley 6485-2」、「Counter 3 (I via KTL)」等を
別の用途に転用することになります。

別のケースとして、カウンタとして nct08 ではなく例えば Ortec974 を使うことが可能です。
Ortec974 を使う接続は、「Ortec974 ch2」、「Ortec974 ch2 (via KTL)」などという
名前で現れます。
BL5S1 としては標準の接続ではないため、
検出器に何が接続されるかを特定していません。
他のビームラインではこの接続が標準になるかもしれません。

いずれにしても、この様な様々な検出器とその接続経路を
XafsM2 上で何という名前で選択ボックスに提示するかは
設定ファイルで決まりますので、つねにこのマニュアルの記述と同じとは限りません。

\section{BL5S1 の構成}

\section{あとがき}

中部シンクロトロンでの実際のビームライン建設が始まる前に
硬X線XAFSラインで測定を行う際の、メインの測定プログラムの具体的な雛形として、
周辺機器との通信部分を仮想的に扱った XafsM を作成しました。
その後 2012年にビームラインの建設が進み、ビームラインの光学素子から
エンドステーションの測定系までの整備が行われた時点で再び測定制御ブログラムの作成を
再開しました。
その際、約2年プログラムを放置したこと、その間に行ったビームラインコントローラ BLC2
の開発を通じて、制御対象との通信方法などでXafsMで想定していた手続きよりも
もっと良いやり方があることが分かってきたことなどから、内部構造の大改定を行い、
プログラムの呼称も XafsM2 に改めることとしました。
とはいえ、かなりの部分まで作った XafsM を完全には捨てられず、
古いコードに自分でも苛立ちを感じつつ、半分以上の部分は XafsM のコードを再利用したため、
全体的にあまり綺麗でない読みにくいコードになってしまいました。
この点を反省して、将来 XafsM3 がありえるかもしれませんが、当面は XafsM2 を
より利用しやすくするための改良に専念するつもりです。

この様に、今の時点の XafsM2 を完成とは思っておらず、
現時点でも改良すべきと感じている点はメモ書きで20点を超えますので、
本当ならば、今の時点でドキュメントを作成するべきで無いかもしれません。
しかし、2013年の春を迎え、ビームラインの供用開始が迫っているため、
仮の版になりますがマニュアルを作成しておくことにしました。

\end{document}

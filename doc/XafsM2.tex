\documentclass[titlepage,a4paper,12pt]{jarticle}
\usepackage{my}
\usepackage{hangcaption}
\usepackage{wrapfloat}
\usepackage[dvipdfm]{graphics}
\usepackage{txfonts}

\setlength{\topmargin}{0cm}
\setlength{\oddsidemargin}{-0.79cm}
\setlength{\evensidemargin}{-0.79cm}
\setlength{\textheight}{23cm}
\setlength{\textwidth}{17.5cm}
\newcommand{\TWpt}{1.0}        % jarticle
\pagestyle{headings}

\renewcommand{\topfraction}{0.99}
\renewcommand{\bottomfraction}{0.99}
\renewcommand{\textfraction}{0.00}
\renewcommand{\floatpagefraction}{.99}
\renewcommand{\dbltopfraction}{0.99}
\renewcommand{\dblfloatpagefraction}{.99}

\renewcommand{\textfloatsep}{0.3cm}
\renewcommand{\dbltextfloatsep}{0.3cm}

\newcommand{\CAP}[1]{\caption{\small #1}}

\title{
  {\gt\fontsize{120pt}{0pt}\selectfont
    XafsM2 \\}
  \vspace*{1cm}
  {\LARGE
    Introduction to \\
    XAFS measurement program Ver. 2\\
    Manual version 0.0
  }
  \vspace*{0.8cm}
}
\author{名古屋大学シンクロトロン光研究センター\\田渕雅夫}
\date{                            2013/1/14 }

\begin{document}

\pagenumbering{roman}
\maketitle
\tableofcontents

%----------------------------------------------------------------------------
\newpage
\pagenumbering{arabic}
\setcounter{page}{1}
%----------------------------------------------------------------------------

\section{はじめに}

あいちシンクロトロン光センタの硬X線XAFS測定ライン BL5S1 で、
ユーザーがビームラインやハッチ内の機器を操作し、測定条件を整えたり、
実際のXAFS測定を行ったりする際の統合的なマン・マシンインターフェイスとして
XafsM2 を準備しました。

このマニュアルでは XafsM2 の機能と操作法を説明しますが、
あとがきでも触れた様に、XafsM2 そのものが、まだ最終版というわけではないため
マニュアルとのズレが出てくる可能性もあります。
それでもビームラインの運用開始にあたってマニュアルの役目をする文章が無くては
困るという事から、プログラムの変更にあたっては
極力文章のアップデートを図ることとし、暫定版を作成することにしました。

本マニュアルと実際のプログラムが違う場合には上記の様な理由です。
違いが大きすぎて分かりにくい、問題があるという場合や、
本マニュアルに無い新規の機能があって使い方がわからない、という場合には
作者にご連絡下さい。
できるだけ早急に対応したいと思います。


\FIG{b}{
  \hfil\scalebox{\TWpt}{\scalebox{0.45}{\includegraphics{OutLookAll.eps}}}
  \CAP{XafsM2の全景}\label{XafsM2の全景}
}

\newpage
\section{XafsM2 の概要}

図\ref{XafsM2の概観}に XafsM2 起動時の概観を示します。

XafsM2 では、「XAFS 測定を行う」という事以外に、
測定に関わる事柄をできるだけ統一的に行えるようにすることを目標にしています。
そのため、「測定条件を決める」、「検出器の調整を行う」、
「プログラムや制御対象の状態を把握する」
など多くの機能を持たせました。
この様な多くの機能をできるだけ簡便に利用できるようにするため、
それぞれの機能を目的ごとにグループ分にけ、
ブロック化して提示するようになっています。

図\ref{XafsM2の概観}に示す様に、XafsM2 の GUI の画面は、
概観するとメニューバーの下に3段のブロックをなす構造になっています。
1段目、画面上部にまとめられているのは、
XAFS の測定で最も重要になる、測定対象元素・吸収端の選択と
現在の入射X線エネルギー表示で、常に表示されます。
(近くここにリングカレントの表示が追加される予定)

\FIG{b}{
  \hfil\scalebox{\TWpt}{\scalebox{0.35}{\includegraphics{OutLook1.eps}}}
  \CAP{XafsM2の概観}\label{XafsM2の概観}
}

2段目は、色々な操作がグループ分けされ、機能ごとにまとまったタブになっていて、
その時々に必要なタブを選択することになります。

最下段は、データやグラフの表示エリアで、ここもタブになっていて
複数面(現状最大10面)のデータやグラフを切り替えて表示することができます。

\section{共通表示部}

XafsM2 の GUI の最上段は、元素選択を行うことと、分光器の状態を表示する部分で
他の部分でタブ選択を行なって表示を切り替えても常に表示されています。

\subsection{元素選択}

図\ref{元素選択部}に示すのが測定対象元素の選択部分です。
実際に元素を選択する方法は2つあります。
一つは図\ref{元素選択部}で「29 Cu」と表示されている元素選択ボックスをクリックし、
現れる図\ref{元素選択ボックス}の様な一覧の中から選択する方法です。
もうひとつは同じく図\ref{元素選択部}で「周期表」と表示されているボタンをクリックし、
現れる周期表(図\ref{周期表})の中から元素を選択する方法です。

元素を選択すると、「エッジ位置」の表示の右に選択した元素の吸収端のエネルギーと
そのエネルギーに対応する分光器の角度が表示されます。
また「対象殻」のボックスで吸収端の種類(K, L$_{\rm I}$, L$_{\rm II}$, L$_{\rm III}$)を
選択すると、対応するエッジのエネルギーと角度の表示になります。

この部分で元素を選択し、
表示された値は実際には XafsM2 の中では参考情報のような扱いで、
\NITEM{
  \item 対象元素のエッジがどこにあるかを人間に教える
  \item 後で述べる「XAFS測定」のタブの中で標準の測定条件の自動生成の際の基準に使われる
  \item 同じく後に述べる「条件設定」のタブの中で、標準的な分光器移動位置を決める
}
という3つの目的にだけ使われます。

「エッジ位置」のエネルギーまたは角度は対象元素を指定して自動表示させるだけでなく
手動で任意の値を入力することができます。
手動で値を入力すると、
「XAFS測定」のタブの中での標準の測定条件の自動生成は指定したエネルギー(または角度)を
基準にして行なわれます。

\FIG{t}{
  \MINI{8cm}{
    \hfil\scalebox{\TWpt}{\scalebox{0.70}{\includegraphics{ElementSelect.eps}}}
    \CAP{測定対象の元素選択部分}\label{元素選択部}
  }
  \MINI{8cm}{
    \hfil\scalebox{\TWpt}{\scalebox{0.80}{\includegraphics{ElementSelectBox.eps}}}
    \CAP{測定元素選択ボックスと元素一覧表}\label{元素選択ボックス}
  }
}

\FIG{t}{
  \FC{\MINI{12cm}{
    \hfil\scalebox{\TWpt}{\scalebox{0.60}{\includegraphics{PeriodicTable.eps}}}
    \CAP{周期表を使った元素選択。
      黄色に表示されているのはK端がラインのエネルギー範囲に適した元素。
      桃色に表示されているのはL端がラインのエネルギー範囲に適した元素。
    }\label{周期表}
  }}
}

\subsection{分光器の状態表示}

\FIG{t}{
  \hfil\scalebox{\TWpt}{\scalebox{0.80}{\includegraphics{Monochro.eps}}}
  \CAP{分光器の角度と分光エネルギーの表示}\label{分光器状態表示}
}

図\ref{分光器状態表示}に示すのは、分光器
\footnote{
BL5S1 の分光結晶は対称 Si (111) で、プログラム内では
その面間隔は 3.13553$\AA$ としています。
メニューバーの「設定」から「結晶・格子定数設定」を選ぶことで、
分光結晶を選択するダイアログが現れますが、これは XafsM2 を他のnビームラインで
使用する時の為のもので、BL5S1 ではこれが必要になることはおそらく無いと思われます。
}
の角度と分光される光のエネルギーを
示す部分です。

図の中にあるチェックボタンで「エンコーダ」を選択すると、表示される角度は
分光器の角度をエンコーダで読み取った結果になり、
エネルギーもその角度から計算されたエネルギーになります。
一方、チェックボックスで「パルス換算」を選択すると、
分光器を回転させているパルスモータのパルス値から$1パルス = 0.00002\dot{7}$degという関係で
計算した角度とエネルギーです。

このチェックボタンは通常「エンコーダ」を選択することをお勧めします。
分光器を回転しているとパルスモータのパルス値と角度の関係を決める際の原点位置は
ズレが生じる可能性があります。
その場合、パルスモータの原点を再定義して正しい表示に戻すのは多少面倒です。
そのような場合でもエンコーダは(正しく較正されていれば)正しい角度を示すはずです。
また、エンコーダの較正が正しいかどうかは、標準的なフォイルのスペクトルを
測定することなどで確認でき、ズレがあった場合でも簡単な操作で修正できます。
具体的な方法は\ref{エネルギー較正}節を参照して下さい。

{\bf 【注意】 測定結果のファイルに記録される「角度」もしくは「エネルギー」と
して書き込まれる値も、このチェックボタンの選択で決まります。}



\section{機能選択部}

XafsM2 の GUI の中段部分は、XafsM2の機能が幾つかのグループに分類されて
まとまったタブになっています。
現在このタブ(機能のグループ)としては、「XAFS測定」、「条件設定」、「SSD設定」、
「データ読込」、「ログ/記録」、「接続状態」があります\REM{(図\ref{タブ一覧})}。

以下、各タブにまとめられた機能について説明します。

\REM{
\FIG{h}{
  \hfil\scalebox{\TWpt}{\scalebox{0.80}{\includegraphics{Tabs.eps}}}
  \CAP{機能選択のためのタブ一覧}\label{タブ一覧}
}}

\FIG{b}{
  \hfil\scalebox{\TWpt}{\scalebox{0.80}{\includegraphics{MeasTab.eps}}}
  \CAP{XAFS測定タブの全体}\label{XAFS測定タブ}
}

\subsection{XAFS測定}

図\ref{XAFS測定タブ}に示す「XAFS測定タブ」には、実際に XAFS 測定を行う際に使用する
機能がまとめられています。

「測定開始」の項にもありますが、
XAFS測定のタブで入力したほとんどの全ての項目は、測定開始後に変更しても
始まってしまった測定には影響を与えません。
「スキャン回数」は例外で測定開始後も変更可能です。

\subsubsection{測定ブロック設定}

タブの左半分を占める「測定ブロック設定」部分では、XAFS測定の際、
どの様なエネルギー範囲を、どの様な刻みで、各点にどれだけの時間をかけて
測定を行うかを設定します。
以下、図\ref{測定ブロック設定}に赤字で記入した番号の要素について説明します。

\FIG{t}{
  \hfil\scalebox{\TWpt}{\scalebox{0.80}{\includegraphics{MeasTab-BlockSetUp.eps}}}
  \CAP{測定時のブロック設定を行う部分}\label{測定ブロック設定}
}

\NENUMERATE{
  \item ブロック数指定: 測定するエネルギー範囲を幾つのブロックに分けるかを指定します。
    現在指定可能な最大ブロック数は 8 です。
  \item 単位指定: ブロックの始点、終点や間隔をどのような単位で入力するかを指定します。\\
    ここで、単位を変更すると、入力済みの数値に関しては自動的に単位換算が行われます。
  \item ブロック始点: ブロックの始点を指定します。
    始点は同時に前のブロックの終点になります。\\
    前後のブロックの「間隔」が入力済みの場合(0でない場合)、
    $(ブロック始点-ブロック終点)/間隔=刻数$となるよう自動的に「刻数」が変更されます。
  \item 間隔: ブロック内で測定の間隔を指定します。\\
    間隔を入力すると$(ブロック始点-ブロック終点)/間隔=刻数$となるよう
    自動的に「刻数」が変更されます。
    間隔は、始点、終点の大小関係によらず「絶対値」で入力して構いません
    (終点のほうが小さい時でも負の数にしなくて良い)。
  \item 刻数: ブロック内に何点の測定点をとるかを指定します。\\
    刻数を入力すると$(ブロック始点-ブロック終点)/刻数=間隔$となるよう
    自動的に「間隔」が変更されます。
  \item 計測時間: 各点をどれだけの時間で測定するかを指定します。単位は「秒」です。
  \item ブロック終点: 最後のブロックの次の始点は、最後のブロックの終点の指定です。
  \item All: 全ブロックの計測時間を一括で指定します。
  \item 標準ボタン: XafsM2 の上部で指定された測定対象元素(厳密には「エッジ位置」)を
    中心に、標準的な測定ブロックの指定を生成します。\\
    「標準EXAFS」は EXAFS 領域まで広がったエネルギー範囲を測定範囲とします。
    「標準XANES」は XANES 領域を測定対象にします。
    「標準XAFS」は EXAFS と同じエネルギー範囲を測定対象にし、
    XANES エリアは XANES 測定と同じ細かな測定ステップを指定します。
  \item 保存・読込: 設定したブロック指定を保存したり、
    保存したブロック指定を読み込んだりすることができます。
}


\FIG{b}{
  \hfil\scalebox{\TWpt}{\scalebox{0.80}{\includegraphics{MeasTab-Right.eps}}}
  \CAP{XAFS測定タブの右半分}\label{XAFS測定タブ右}
}

\subsubsection{検出器設定}

タブの右上部では測定に使う検出器を指定します。

左端の、チェックボタンで選択された検出器が測定に使用される検出器です。
「I0」は常に選択され、非使用にすることはできません。
残りの「I」、「19ch SSD」、「その他 1」、「その他 2」は複数選択可能ですが
最低1つは選択していないと測定が始まりません。

図\ref{XAFS測定タブ右}に示した 1. は、
検出器として「その他1」、「その他2」を選んだ場合の測定のタイプを選択するボックスです。
透過型の測定なら$log(I_0/A_1)$(または、$log(I_0/A_2)$)を、
蛍光型の測定なら$A_1/I_0$(または$A_2/I_0$)を選んで下さい。

現在 XafsM2 では、測定結果を記録するファイルのフォーマットは、
いわゆる「9808」型のファイルです。
このファイルには、全体で一つ測定のタイプを記録するフィールドがありますが、
XafsM2 では、「選択した検出器が一つだけ」の場合、
\NITEM{
  \item I を選択: 透過型の測定と記録
  \item 19ch SSD を選択: 蛍光型の測定と記録
  \item その他1 または 2 を選択: $log(I_0/A)$ を選んでいれば透過型の測定と記録、
    $A/I_0$の場合には蛍光型の測定と記録
}
という規則でファイルに記録します。
複数の検出器を指定した場合には全て EXTRA型の測定と記録します
\footnote{
  複数の検出器を選択してもそのタイプが全て一致していれば(全部透過型とか蛍光型に)、
  測定ファイルには「そのタイプの測定」と記録しても良いのですが、現在そうなっていません。
  ファイル全体に一つの記録モード指定以外にも、
  検出器ごとに測定モードを記録できるフィールドがあるので問題にならないはずです。
}。
ここでの「測定の型」の選択は、測定中の測定結果の表示にも影響します。

\subsubsection{バックグラウンド}\label{バックグラウンド}
XAFS測定タブの右中段には、バックグラウンドを扱う部分があります。
XafsM2 では、バックグラウンドをいつ測定するかに関して、
\NITEM{
  \item XAFS測定(スキャン)の直前に測定する
  \item バックグラウンドの値を事前に測定しておく
  \item バックグラウンドの値を手入力する
}
という 3つの選択肢があります。

測定の直前に測定する場合には、図\ref{XAFS測定タブ右}の 2. で
「スキャン前に計測」を選択して下さい。
「計測済みの値を使用」を選択すると、事前に計測するか手入力した値を使用することになります。

「計測済みの値を使用」を選択した場合、XAFS測定開始前にバックグラウンドの値を測定するか、
手入力しておく必要があります。バックグラウンドを計測するには次の様にして下さい。
\NENUMERATE{
  \item 図\ref{XAFS測定タブ右}の 3. に、計測時間を入力する。
  \item 図\ref{XAFS測定タブ右}の 4. の「バックグラウンド計測」ボタンを押す。
  \item ボタンの色が図\ref{バックグラウンド計測ボタン}の様に赤く変化し、
    表示も「シャッターCLOS確認」に変わる。
  \item シャッターが閉まっていることを確認して、このボタンを押す。
  \item ボタンの色が今度は黄色に変化し、表示は「BG計測中」に変わる。
  \item 計測後、ボタンの色が再び赤くなり、表示が「シャッターOPEN確認」に変わる。
  \item 必要ならばシャッターを開け(不要ならば開けなくても構わない)
    もう一度このボタンを押す。
  \item ボタンの表示が元に戻り、計測プロセス終了。
}
バックグラウンドの値は、内部的には「1秒あたり」の数字として記憶されますので
測定の際の各点の計測時間とバックグラウンドの計測時間が一致する必要はありません。

バックグラウンドの値を手入力する場合は後で説明する「条件設定」タブの中で行います。

「スキャン前に計測」を選択した場合、計測(スキャン)開始のボタンを押した後、
「バックグラウンド計測」ボタンの色と表示が上記の説明と同様に変化しますので
指示に従ってシャッターの開閉を行なって下さい
\footnote{近い将来シャッターの開閉を自動でお行なうようにする予定ですので、
「表示に従ったボタン操作」は不要に和るかもしれません。}。

\FIG{t}{
  \hfil\scalebox{\TWpt}{\scalebox{0.80}{\includegraphics{BGMeasB.eps}}}
  \CAP{「バックグラウンド計測」ボタンの変化}\label{バックグラウンド計測ボタン}
}

\subsubsection{データファイル}

XAFS測定タブの右三段目の「データファイル」の項では、
測定結果を記録するデータファイル名の選択と、
データファイルにコメントとして書き込む文字列の入力を行います。

複数回スキャンを行う場合、
データファイル名の拡張子(通常は「.dat」)は、自動的に変更され
1回目もとの拡張子、2回目「.001」、3回目「.002」、... の様に設定されます。

この、拡張子が変更されたファイル名に関してはすでに存在しているファイルかどうか、
上書きのチェックは行なっていません。

\subsubsection{条件確認}

XAFS測定タブの右最下段の「条件確認」の項には、
総測定点数と予想測定時間が表示されます。
この項目はどちらも表示だけです。
予想測定時間は測定点数に確定点の測定時間をかけて加え上げただけのもので
実際の測定時間とは1.5倍程度の差が出ることがあります。

\subsubsection{測定開始}

XAFS測定タブの右最下段の「測定開始」の項では、
測定終了時に分光器の角度をどこに移動するかと、スキャンを何回繰り返すかを指定できます。

XAFS測定のタブで入力した他の項目は、測定を開始した後に変更しても、
始まってしまった測定には影響を与えませんが、{\bf 「スキャン回数」だけは
測定開始後も変更可能です。}

\subsection{条件設定}

図\ref{条件設定タブ}に示す「条件設定タブ」には、
XAFS測定を開始する前に、試料や測定系の状態を確認したり、測定条件を
決めるための機能がまとまっています。

\FIG{b}{
  \hfil\scalebox{\TWpt}{\scalebox{0.80}{\includegraphics{MeasCond.eps}}}
  \CAP{条件設定タブの全体}\label{条件設定タブ}
}

\subsubsection{分光器回転}

タブの左上部「分光器回転」では
分光器を希望のエネルギー、角度に移動させることができます(図\ref{分光器回転})。

図\ref{分光器回転}の 1. に示すように移動先は 4つまで入力できるので
決まった何点かを交互に移動しながら
測定条件を決めるようなことに利用できます。
「元素選択」で元素と吸収端を選ぶと、それに合わせてデフォルトの移動先が設定されます。
デフォルトは吸収端のエネルギーを基準にして
 -0.5keV, -0.1keV, +0.1keV, +1.0keV の 4点です。

移動先を設定する際の単位は、それぞれの入力欄の右の選択ボックス(図\ref{分光器回転}の 2.)
で変えられます。
選択できる単位は keV, eV, deg, $\AA$ の 4種類です。
単位を変えると、入力されている数字は自動的に選択した単位に変換されるので、
あるエネルギーに対応する角度を調べる、というような用途にも使えます。

図\ref{分光器回転}の 3. のエネルギー選択ボックスで単位を変えると、
4つの単位入力を一斉に変更することができます。

図\ref{分光器回転}の 4.の「H, M, L」のボタンを押すことで、
移動する際のパルスモータの速度を選ぶことができます。
どの速度を選んでも構いませんが、「L」で大きな角度移動をすると時間がかかり、
「H」では、到達する角度が指定した角度と多少ずれる可能性がある、
ということを考慮して適宜選択して下さい。

\FIG{t}{
  \hfil\scalebox{\TWpt}{\scalebox{0.80}{\includegraphics{MeasCond-MonoCTRL.eps}}}
  \CAP{分光器を希望のエネルギー、角度に移動させる}\label{分光器回転}
}

\subsubsection{レンジ選択}

\FIG{b}{
  \hfil\scalebox{\TWpt}{\scalebox{0.80}{\includegraphics{MeasCond-Range.eps}}}
  \CAP{測定器のレンジ選択}\label{レンジ選択}
}

\subsubsection{バックグラウンド確認/設定}
\subsubsection{移動/スキャン}
\subsubsection{計測値モニタ}

\subsection{SSD設定}

\subsubsection{SSD選択(MCAスペクトル)}
\subsubsection{SSD選択(積算/本測定対象)}
\subsubsection{SSDの各チャンネルの設定}

\subsection{データ読み込み}

\subsubsection{ファイル選択}
\subsubsection{Viewを閉じる}

\subsection{ログ/記録}

\subsection{状態表示}

\subsubsection{スターズサーバ状態表示}
\subsubsection{ドライバ状態表示}

\section{グラフ表示部}

\subsection{XYView}

\subsection{TYView}

\subsection{MCAView}

\section{その他の機能}

\subsection{Starsサーバ選択}

\subsection{メッセージ表示エリア}

\section{標準的な測定操作}

\subsection{標準的なXAFS測定}

\subsection{標準的なエネルギー較正}\label{エネルギー較正}

\subsection{スキャン}

\subsection{分光器の$\Delta\theta_1$の較正}

\section{起動方法・設定}

\section{定義ファイル}

\section{あとがき}

中部シンクロトロンでの実際のビームライン建設が始まる前に
硬X線XAFSラインで測定を行う際の、メインの測定プログラムの具体的な雛形として、
周辺機器との通信部分を仮想的に扱った XafsM を作成しました。
その後 2012年にビームラインの建設が進み、ビームラインの光学素子から
エンドステーションの測定系までの整備が行われた時点で再び測定制御ブログラムの作成を
再開しました。
その際、約2年プログラムを放置したこと、その間に行ったビームラインコントローラ BLC2
の開発を通じて、制御対象との通信方法などでXafsMで想定していた手続きよりも
もっと良いやり方があることが分かってきたことなどから、内部構造の大改定を行い、
プログラムの呼称も XafsM2 に改めることとしました。
とはいえ、かなりの部分まで作った XafsM を完全には捨てられず、
古いコードに自分でも苛立ちを感じつつ、半分以上の部分は XafsM のコードを再利用したため、
全体的にあまり綺麗でない読みにくいコードになってしまいました。
この点を反省して、将来 XafsM3 がありえるかもしれませんが、当面は XafsM2 を
より利用しやすくするための改良に専念するつもりです。

この様に、今の時点の XafsM2 を完成とは思っておらず、
現時点でも改良すべきと感じている点はメモ書きで20点を超えますので、
本当ならば、今の時点でドキュメントを作成するべきで無いかもしれません。
しかし、2013年の春を迎え、ビームラインの供用開始が迫っているため、
仮の版になりますがマニュアルを作成しておくことにしました。

\end{document}

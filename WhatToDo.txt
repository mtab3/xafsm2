○ モーターのストップがない!

○ 19ch SSD データ記録、ダークの扱い関係、一応は落ち着いた
   ただし、全部 offline で直したので、実際に正しい値になっているか、
   ICR が [count/秒]で良いか、等は要検討。

○ 縦軸を1つだけ(2つだけ)にする指定 <<-- ?

○ 例えば、Cu-K のエッジに決め打ちして、較正のシーケンスを勝手に行う、
　というのも良さそう。
○ XafsM2 にエンコーダの値セットの機能を持たせられるはず。
○ LS ring に対応するべき
○ XYView で、マウスカーソル位置の値を表示するモードと線を選択するモードを分離する。
○ XYView で、キー修飾やボタンの種類をどの機能に割り振るかを設定可能にする。
○ XYView で、選択するモードに入る修飾キーを作ってみる。
○ MwMeas BLKstart, step, ... の入力時、追随して他の数値を変えるために
     editingFinished でひろっているのをどうするか検討

○ 野村フォーマットだと、開始・終了時のリング電流がいる。
   LS をサポートする。
○ SSD 横軸補正
○ ハッチ内の装置コントロール
○ ハッチ内シャッタ。
○ 吸収補正の計算
○ バッチ処理
○ Measure とかのデータを読むとき、情報不足で軸の名前とかがちゃんと書けない。
　　果たして、野村フォーマットにこの情報を埋め込めるか。

○ SC410 スピード設定とか
○ SC410 関連で起動時にへんな GetValue が出てるみたい...だけど、いいか。
○ Scan が正常に始まらなかった時 View を専有したままになってしまう。

○ Monitor で SSD 選択時、各チャンネルのデータや MCA の生データを残す機能は要らないか？
○ Measure で SSD 選択時、MCA の生データを残す機能は要らないか？

○ Save のタイミングが前だったり後だったり... どうしましょ。
○ MCA 後からチャンネル切り替えで、リアルタイム、ライブタイムの表示がおかしい
○ MCA その他も cps ではなく count になってるがどうする。
○ グラフ表示部分を直接 XView にせず、コントロールを含んだコンテナにする

○ MainWindow オンリーワン class 構成をやめたい。

○ Keithley で、あえて固定レンジを選ばないと言う選択も欲しい
○ チューニングありスキャン
○ Keithley でスキャンした時、最初の一点がおかしい
○ 内部的には現在位置等を keV 基準で持っているのはまずそう。deg 基準に直したい。
○ 測定時、バックラッシュとりをやるべきか？ (PM16Cの設定だけで OK?)

○ Scan モードの時の横軸の表示。
   相対か絶対か、単位ありかパルスか。その単位の表示

○ ピエゾ　がまともに動いているかどうかは未確認。

○ 分光器：測定中はマニュアルで動かないようにロックする
            その為のフラグ立ては、外部での仕事にして、
　　　　　　2種類(マニュアル、測定)の「移動コマンド」は廃止

○ 野村ファイルフォーマットに真剣に対応(以下残ってる問題点)
  ・記録する際の横軸単位指定は「度」か「度以外」とする。
  　「度以外」の時は全部エネルギーに直す。
　・パラメータファイルの名前書き出しはやってない
　・Ortec でも Camac でも無いので、Scaler を「SCALE」とし、そのコードを「2」にした。
　・Offest はまだ真面目に扱ってない --> 真面目にやった
　・FLUO のとき、各チャンネルのモードを真面目に書いてない
	 --> 半分大丈夫 (後半 ICR とかがだめ)
　・各点の記録にエンコーダのよみを入れていない --> 入れた
　・各点の記録は野村フォーマットを無視してI0と測定に使ったチャンネルのデータを
	ずらっと並べただけ
　・ヘッダ部分に終了時でないとかけない情報がある、今は、置換用の記号を埋めるだけで
　　実際の再読み込み + 置換   --> やった。

○ Keithley の測定時間設定をどうするか再考の必要あり
○ マルチディテクタをファイルに記録する際にどうやって対応するか
○ GUI をもう少しビューティフルに
○ umi と統合とかありえるか? 

○ データファイル書き出しを真面目に
○ 設定ファイルの読み書き
○ 測定データ表示 (データを読み出して表示)
○ 単なる最大値決定になってるピーク位置決定を真面目にやる
○ 縦軸のスケール決定がダメすぎ

○ 吸収係数の計算統合？
○ I, I0 のお勧めガス表示
○ エネルギーレンジを変えた時の光学系の設定変更、あるいは設定変更おすすめ。

#########################################################################

対処済み 2013.2〜
○ MCAView で一度設定した ROI を修正できるようにした。
   (毎回1からではなく、決めた ROI のどちらかの端点の修正ができるようにした)
○ 周期表に色をつける範囲を自分で選べるようにした

○ 以下の、19ch SSD データ記録、ダークの扱い関係、一応は落ち着いた
   ただし、全部 offline で直したので、実際に正しい値になっているか、
   ICR が [count/秒]で良いか、等は要検討。
　○ 19ch SSD のフィアル記録 19ch 分展開する。19ch 分 icr。19ch 分 offset
　○ SSD は(GetValues した後は)内部的に
　   TotalEvents, CountsAll, CountsInROI, ICRs を記録するようにした。
　○ 19ch SSD のダーク測定 に話が波及 !!
　   SFluo に対して Dark 測定したときは、
　   (AUnit*)SFluo の内部に 19ch 分の Dark が保管されるようにする。--> した。
　○ SSD 使った XAFS 測定の時、測定ファイルにはちゃんと 19ch 分のデータが書かれているか
　　　要確認
　○ SSD に IRC も記録


○ 19ch SSD (TotalF) が存在しないと異常終了してた。
○ レンジ設定できる検出器がないと異常終了してた。

対処済み 2013.1〜
○ データ読み込み表示で、線の色の選択をも一回生かしてみようかな。
    やりかけ、色を選ぶところまではできたけど、
　　それを実際にグラフの色にするのはできでてない。
○ MwMeas 計測データファイルの選択のタイミングと測定開始のタイミングで2回
   上書き確認を行なっているが、選択のタイミングで確認済みなら、
   測定開始時には確認しないようにする。
○ MwMeas ChangeBLKstart で、スタート位置を変化させた時、
     前後のブロックで「間隔」を固定して「刻数」を変えるべき。

○ offset の使い方確認 (今は測定したその場で引いている)。--> PF, SPring8 ともこれで OK
○ 設定されているダークの値確認と、ダークの値をて入力でセットできるようにした。
○ 「バックグラウンド測定」まで進んだ状態で「Stop」した時、「バックグラウンド測定」は
　止まっていなかったのを修正した。
○ nct08 via keithley 等について、レンジ設定で「auto range」も選べるようにした。
○ Fio.pp でチャンネルのモード、オフセットをちゃんと書くようにした。
    --> Data 読み込み表示でも、チャンネルごとにモードを決めて表示可能になったはず
○ Data 表示のために 9809 ファイルヘッダのパーサを真面目に書いた。めんどくさかった。
   結果、透過モードかどうかの情報しか使ってない...
○ XYView がわりとだめ。--> たぶんもうだいたい良い
　　多数のデータを重ねて表示することを想定した group が全然有効に機能していない。
　　多数表示されるグラフに対応した縦軸の表示や、どれがどの線かの区別をどうつけるかが
　　きまらずにごちゃごちゃしたが、マウス指示でアクティブに軸表示や
　　関連情報表示を行うようにしよう。
○ データ読み込み。 だいたいまともになった。
　　だけどその過程で XYView の group の考え方がダメなのがはっきりしてきた。
    group はやめよう。
○ XView 部分拡大 -> XYView で Zoom, 並行移動、領域選択拡大を実装
○ Scan, Measure でマウスカーソル位置のｙ軸の値が表示されなくなってる->直した
○ Dwell Time に制限がある場合、実際に設定するときに値を変えてしまうことがあるが
　その旨を通知するようにした。(通知するだけ)
  --> OTC, OTC2 で働くかどうかは要チェック -> 大丈夫そう
○ Ortec974 に対応。CNT, CNT2 に対応して OTC, OTC2 を実装。動くかどうかは現場でチェック
○ ダーク測定のためシャッターオープンクローズ確認シーケンス導入
○ ダーク測定関係対処終了
○ ダーク測定    AUnit にダークを保持する変数をもたせる。
○ Scan の時の表示の Normalize 真面目に対応する
○ XYView で mouse 位置の値表示やりかけ
    横軸の目盛り数字正常化と込で終了
○ puls -> energy, angle の変換が変 ?? 大丈夫な気もする。　現場で再チェック
    --> 定義ファイル(XAFSM.def)が間違ってた
○ 周期表で元素選んだ時の反応が変
   修正. エネルギーが範囲外になって選択をはねた時も、表示上では選択できたことになってた
○ 同じ keithley に対して Keithley ドライバ直接と nct08 経由で同時に使おうとすると
   まずいんでないかい。ハネるべき。
○ DeadTime 表示
  　　 青   ->  緑   ->  黄   -> オレンジ -> 赤　　にするとしたら？
      0 0 1 -> 0 1 0 -> 1 1 0 ->    ->      1 0 0
       0 %      10%      20%        ->       100%
○ MCA スペクトルは、チャンネルを切り替えるたび追随して、既に測定されている
　そのチャンネルの測定内容を表示できるはず。 ---> iできるようにしたつもり要確認
○ 微調整: 日本語ファイルの更新。
○ 画面の一番上で、吸収端に関しては keV, deg、分光器位置は deg, keV の順で
　　表示していたのを揃えた。
○ GetRange できるようにした
   GetRange で選択中のセンサーのレンジを取り込む。
　 GetAllRange でレンジ選択できる全部のセンサーのレンジを取り込む
○ "CNT2" に関する若干のバグ取り
○ Range 設定ができる(必要な)センサーを使って測定を開始しようとするとき
　注意を促すダイアログポップアップ
○ Keithley をプリアンプ代わりにしてカウンタを使った測定をする際、レンジの扱い
　(今はオートレンジに頼ってる)
　レンジ指定もできるようにするべき --> CNT2 ができたので内部的にはできる。
　ユーザーインターフェイスをどうするかが問題。どうにかした。
○ V/F コンバータの向こうに Keithley をつなぐとき
　実際には、単にカウンタではなく Keithley の初期化も必要になるので
　派生したディテクタとして扱えるようにするべき --> CNT2 有効にした。要チェック!!
         --> ダメだった。nct08 のドライバ宛に Keithley のコマンドを投げる。(当然だ!)
         --> 2nd driver の指定が必要。やった。一応動いてる
　だけどこれ、一般的にはどうするんだ？ V/Fコンバータやcounterの向こうに
　いろんな物がつながるのは一般的には色々ありえるけど、その都度全部拾うのか？
　--> ひろうのは簡単そう
○ Log メッセージ末尾の「改行」を整理。
○ MCA モードの時に指定時間で止まる機能がいる気がする。　　できてるつもり。できてた。
○ 起動オプションを解釈するようにした。
     -e : 英語版として起動
     -j : 日本語版として起動 (default)
     -d [file-name] : XASFM.def の代わりに[file-name]を定義ファイルに使う。
○ XAFSM.def の内容を確認。simmotor 使用版と、全部リアル版を明確にする。
     XAFSM.def.BL5S1 : 全部リアル版
     XAFSM.def.BL5S1.usingSimmotorButSSD : SSD 以外 simmotor

○ 久しぶりに日本語化を真面目に。
○ 今まで XafsM2 : 英語版で起動、XafsM2j : 日本語版で起動だったのを
   XafsM2 : 日本語版で起動、XafsM2e : 英語版で起動に変えた。
○ Scan, Monitor, MCA のデータセーブに対応
○ SSD(19ch all)を選んだ時、SSD Setup 画面で選択したチャンネルだけの合計を取るようにした。
○ XView の XY プロットモードと Ring モードを切り分けて別々にした。
   (MCAView の作成に合わせてした準備はかなり進んだはず)
○ モニターの時の縦軸の目盛りまじめに --> ある程度真面目になった
○ モニター時にマウスで時間シフトできるようになった。

対処済み 2012.12〜

○ Status 画面の2つの clear ボタンの動作
　・"Clear Busys" は該当するユニットの isBusy, isBusy2 プロパティをクリアする。
　　画面上の状態表示を直接は操作しないが、
　　その結果発生する signal で、画面上の状態表示も更新される。
    isBusy2 は、プログラムの内部フラグなのでクリアしても大きな問題は無いが、
    isBusy は本当は制御対象の状態をこちらにコピーしたフラグなので、クリアすると
　　対象の状態とずれる危険がある。
　　しかし実際には、
　　「対象の状態とずれてしまった結果、対象はクリアなのにクリアになっていなくて
　　　プログラムの動作がブロックされてしまう。」という状況を救うために使うはずなので
　　多分問題なし。
　・"Clear Enable" は該当するユニットの enable プロパティを真にする。
　　この時、isBusy, isBusy2 も同時にクリアする。
　　これも上の、isBusy 問題同様、制御対象が enable かどうかは、制御対象の状態によるので
　　勝手にプログラム内のフラグだけをクリアするのは危険。
　　しかしやはり Clear Busys 同様、
　　「対象の状態とずれてしまった結果、対象はenableなのにenableと認識されていなくて
　　　プログラムの動作がブロックされてしまう。」という状況を救うために使うはずなので
　　よしとする。

○ 起動時に各ユニットが enable かどうかの判定は、Stars サーバ相手の
　　listnodes コマンドの応答で決めている。
　　またその後は、_connected, _disconnected のイベントを監視している。
　　(上記のどれかのイベントで)デバイスの状態を disable から enable に変える際には 
　　isBusy, isBusy2 も同時にクリアしている(逆の場合には操作しない)。
　　これは、Stars サーバの動作をモニタしていると実際にはかなり危険で、
　　「enable なのに listnodes に出てこない」とか「disable なのに出てくる」、
　　あるいはデバイスの connect, disconnect が検出されずイベントが発生しないということが
　　あり得る。
　　「enable なのにそう認識されていない」場合は、「Clear Enable」で強制的に
　　enable にできる。(当然だが制御対象を enable にするのではなく、
　　プログラム内で対象が enable だと認識された状態にする。)
　　「disable なのに enable と認識されている」場合は、
　　そのデバイスを使った動作をしようとした時点で、isBusy か isBusy2 がクリアされなくて
　　動作が進行しなくなるはず。その場合は、clear busys ボタンで逃げて、
　　対象デバイスが正常に接続されるまで、そのデバイスを使わないようにする。

○ enable/disable, isBusy, isBusy2 の状態を監視し続けるのは
　　プログラムの動作に大きな負荷になる可能性がある
　　(実際には測っていないので問題ないぐらい軽い動作かもしれない)。
　　「Status watch active」ボタンで監視する・しないを切り替え可能。
　　ただし、これを on にしても off にしても、内部のフラグ enable, isBusy, isBusy2 は
　　通常と同じくセットリセットされる。単に変化が表示に反映されないだけ。

○ SLOT の中で、SIGNAL の発信者を特定するのは sender() !!!!!!!
  これで GUI 自動生成プログラムで怖いところがほぼなくなった。
　にしても、もう少しシンプルな方法が欲しい。
  (Motif が懐かしい)

○ ドライバの Status 表示を実装
　久しぶりにガッツリ遊んだ感じ。
　ドライバの connect, disconnect に応じた enable/disable の表示
  isBusy, isBusy2 のセットの状況を見えるようにする。
  さらに、なんかのトラブルで isBusy, isBusy2 がセットされっぱなしになった時
　強制的にクリアするボタンも実装。
　だけど、先にやった connect/disconnect の監視や Er: をリカバーする機能が
　結構まともに働いているので出番が無いかも。

○ Stars ドライバの状況に対してできるだけコンクリートになるようにしたい計画
　○ ドライバ・デバイスが使えない時に、できるだけ異常動作にならないように
      (典型的には、Scan 等が進行しなくなり、正常になった後に Stop/Start しても
      	復帰しないなど)
　　　Stars 上のデバイスのコネクト、ディスコネクトの状態を反映して、
　　　デバイスのアクティブインアクティブを制御するようにする。
　○ ついでに、起動時に listnodes をチェックして、起動時点で使えるデバイスもチェック
     ただし、これはやらないほうが良いかもしれない。
     (BL5S1 の Stars server が listnodes に正常に応えない時があるように思えるため)
　○ Ok: でなく Er: もひろう。
○ 使用する Stars ドライバリストを XAFSM.def で与えようと思っていたけどやめて
　XAFSM.def の各ユニットの定義から拾って、自分でドライバリストを作るようにした。

○ Scan の時 Stop に対する反応が遅い。(dwell タイム分待たないと反応しない)
　　ストップボタンの色だけ先に変えるようにした。
○ MCA Start-Pause ボタン体制から Start-Clear ボタン体制に変更中
○ MCA の Ch を変えた時、次回のスタートでは勝手にクリアされるようにする。
○ 例えば MCA の描画中 (Stop を押していない状態)で、同じ画面を使って Monitor を
　スタートしようとすると落ちる (MCAView とか色々が delete されるため)
○ MCA Dead Time 表示、取得。
○ Set Up の画面が手狭になったので、MCA を切り分ける。
○ MCA 画面内に情報。RealTime, LiveTime, CPS,...
○ XAFSM.def で、センサーに関して親ユニットがあるかないかと、その親ユニットの指定を入れた
○ XAFSM.def で、ユニークな識別子の定義を入れた
○ XAFSM.def で、モータの移動単位が REAL か INT かを示す項目を入れた。
   PM は INT, PZ は REAL
○ SSD 使えるようになってきたけど、まだ大変。
　シングルチャンネル含めて設定をやる画面つくった。
  ROI, peaking, dynamic, calibration, threshold, MAC サイズの確認　まで済。
　Real/Live は Real こていでいいかな。
○ SSD 設定画面
○ XView 測定結果の中にカーソル
　Measure, Monitor, Scan 全部
○ MCAView は XView と独立に作った。
○ V/F コンバータを BL5S2 からもらったので、Keithley を I-V コンバータに使って、
　NCT08 を通した測定が可能になった。
　I0, I1 につながった Keithley の出力を V/F コンバータに入れ、
　その出力を NCT08 の Ch2, 3 で数えている。
○ モニタに nct08 を必須にしない
○ モニタの時の dwell time  :: できてるはず
○ Scan モード多分できた。
○ 仮のコードだった個々のStars クライアントとの通信コードを実コードと置き換えはじめる。
  1. nct08 対応済 (もう少し細かいチェック必要)
　2. Keithley とりあえず実装 : 未確認
　3. エンコーダ　スケルトン実装
○ 軸の位置はエンコーダで判断するようにする
○ モータのパルスで見た角度とエンコーダで見た角度の整合をとる。--> とらない。
○ ファイル書き出しするようになってる。
○ ピークスキャン、タイムチャートとりあえず完成。
○ 測定結果のファイル名を、画面上の入力で変更しても、ダイアログの方が変わらない


○ アイデアとしては以下のように完全 Timer 排除ができるはず。やらない。
   測定開始時に emit - connect で、MeasSequence を呼び出す。
   MeasSequence からは、必ず Stars のコマンドを一つは発行してから抜けるようにする。
   発行されたコマンドに対する Stars からの応答を受ける関数の中から emit-connect で
   MeasSequence を呼び出す。


対処済み 2012.10〜

○ Monitor のグラフ表示整理
○ BLC2 から Stars サーバのアドレス等の設定関係のコードを移植 動いてるか? たぶん大丈夫

○ Stars.cpp ConnectionStage は enum にする。
   (SendCMD 等で最終ステージに着てるかどうかをちぇっくする)
○ ConnectionStage の 2段階目で Stars からの応答をチェックするようにした
○ Stars.cpp 接続開始をイベントドリブンにした
○ show は Initialize の後にしたいけど今はやってない。
○ 相手を変えて ReConnect 正しい相手にして ReConnect しないと繋がらなかったのを修正
○ グラフ表示のスケール決定がメチャクチャ。ー＞とりあえずは見られるようになった
○ 検出器ごとにデータ取り扱い法を指定できるようにする。
   log(I0/I1), I/I0, ... 等
○ nct08 の GetValue 関係で、一つ前の値を読んでしまっている。
○ MwSetup で、一般のモータ移動の欄 BLC2 版の Stars 通信に対応済
○ MwSetup で、モータの名前と実際に指定されるモータがずれていた
○ それに合わせて、BLC2 同様に別名を使えるように変更
   XAFSM.def の中の XAFSName, XAFSKey, XAFSTitle
○ BLC2 のコードを元に、軸の移動や検出器の操作等をポーリングでなくイベント駆動に書き換える
○ 仮のコードだった個々のStars クライアントとの通信コードを実コードと置き換えはじめる。
  0. pm16c04 対応済み
○ センサーの初期化処理を「どかん」とやってしまってる。
   ---> 少なくとも測定開始時は丁寧にやるようにした
○ 周期表での測定対象元素指定

○ 野村ファイルフォーマットに真剣に対応中
　・どうせ野村フォーマットにしないなら、エネルギーと角度を両方書いた方がいい

対処済 2011.2.16 〜

○ 計測中の現在位置表示 (繰り返し何回目、何ブロック目、何ステップ目) : 取り合えず OK
○ BlockStart ... は、計測開始時にコピーして使う (Repeat だけは計測中に変更可)
○ pause を生かす
○ stop 時の「ほんとに？」ダイアログ。
○ 終了時の戻り位置指定
○ 見積り測定時間の表示
○ 測定開始前のデータ点検
○ Stars との接続 (その先の dummy デバイスとの接続)
○ 作業ログ
○ データのリアルタイム表示
○ 結晶変更 (プログラム側での変更だけ)
○ Stars シミュレーションコード削除
○ モーターの単純移動
○ Scan/Search の実装
○ SoPS: 相対移動をもう少し考える(width 指定、始点終点指定の使い分け)
○ ピーク位置決定
○ SoPS: スキャン中のモータの位置表示位置を考える
